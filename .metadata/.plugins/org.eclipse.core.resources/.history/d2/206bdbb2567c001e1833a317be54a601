package dm3;

import java.awt.Color;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.concurrent.atomic.AtomicInteger;

import javax.swing.JTextField;
import javax.swing.SwingUtilities;

class ButtonClickListener implements ActionListener {
    private JTextField mainDisplay;
    private AnswerChecker answerChecker;
    private boolean secondAttemptAllowed;
    private String lastOperation;
    private int lastDividend;
    private int lastDivisor;
    private JTextField correctDisplay;
    private JTextField attemptDisplay;
    private AtomicInteger correctCount;
    private AtomicInteger attemptCount;
	private GuiView guiView;

    // Constructor that accepts the main display text field
    public ButtonClickListener(JTextField mainDisplay, JTextField correctDisplay,
    		JTextField attemptDisplay, AtomicInteger correctCount, AtomicInteger attemptCount,
    		GuiView guiView) {
        this.mainDisplay = mainDisplay;
        this.correctDisplay = correctDisplay; // Initialize correctDisplay
        this.attemptDisplay = attemptDisplay; // Initialize attemptDisplay
        this.correctCount = correctCount; // Initialize correctCount
        this.attemptCount = attemptCount; // Initialize attemptCount
        this.answerChecker = new AnswerChecker(); // Initialize the AnswerChecker here
        this.secondAttemptAllowed = true;
        this.guiView = guiView;
    }

    
	
    public void actionPerformed(ActionEvent e) {
        String command = e.getActionCommand();
        if ("On".equals(command) || "New".equals(command)) {
            mainDisplay.setText("=");
            secondAttemptAllowed = true;
            lastOperation = null;
        } else if ("Enter".equals(command)) {
            evaluateAnswer();
        } else {
            // If the current display is just "=", clear it before appending
            if ("=".equals(mainDisplay.getText())) {
                mainDisplay.setText("");
            }
            // Append the button text to the display unless it is the initial "="
            mainDisplay.setText(mainDisplay.getText() + command);
        }
    }

    private void evaluateAnswer() {
        String displayText = mainDisplay.getText();
        if (displayText.contains("=")) {
            // Extract the operation, numbers, and the answer
            String[] parts = displayText.split("[÷×\\-+]|=");
            if (parts.length == 3) {
                try {
                    int firstNumber = Integer.parseInt(parts[0].trim());
                    int secondNumber = Integer.parseInt(parts[1].trim());
                    int userAnswer = Integer.parseInt(parts[2].trim());
                    String result = "";
                    if (displayText.contains("÷")) {
                    	if (lastDivisor == 0) {
                    		mainDisplay.setText("Can't Divide By Zero");
                    	}
                        lastOperation = "÷";
                        lastDividend = firstNumber;
                        lastDivisor = secondNumber;
                        result = answerChecker.checkDivisionAnswer(firstNumber, secondNumber, userAnswer);
                        if ("Good job, hit 'New' to try another!".equals(result)) {
                            mainDisplay.setText(result);
                            secondAttemptAllowed = true; // The answer is correct, allow new problem
                        } else {
                            if (secondAttemptAllowed) {
                                // Display the correct quotient and remainder
                                mainDisplay.setText(result);
                                secondAttemptAllowed = false;
                            } else {
                                mainDisplay.setText("Incorrect, hit 'New' to try another!");
                                secondAttemptAllowed = true; // Allow a new problem after the wrong answer
                            }
                        }
                        if (result.startsWith("Good job") || result.equals("Correct")) {
                        	correctCount.incrementAndGet(); // Increment the correct count
                            // Check if correct count is 10 for multicolor flash
                            if (correctCount.get() == 10) {
                                SwingUtilities.invokeLater(() -> ((GuiView) SwingUtilities.getWindowAncestor(mainDisplay)).flashMultiColor(5000));
                            } else {
                                // Flash light for single correct answer
                                SwingUtilities.invokeLater(() -> ((GuiView) SwingUtilities.getWindowAncestor(mainDisplay)).flashLight(Color.GREEN, 500, 2000));
                            }
                        }
                        attemptCount.incrementAndGet(); // Increment the attempt count regardless of correct or incorrect
                        
                        // Update the display fields
                        correctDisplay.setText(String.valueOf(correctCount.get()));
                        attemptDisplay.setText(String.valueOf(attemptCount.get()));
                        return; // Return here so it does not go to the code below intended for other operations
                    } else if (displayText.contains("+")) {
                        lastOperation = "+";
                        result = answerChecker.checkAdditionAnswer(firstNumber, secondNumber, userAnswer);
                    } else if (displayText.contains("-")) {
                        lastOperation = "-";
                        result = answerChecker.checkSubtractionAnswer(firstNumber, secondNumber, userAnswer);
                    } else if (displayText.contains("×")) {
                        lastOperation = "×";
                        result = answerChecker.checkMultiplicationAnswer(firstNumber, secondNumber, userAnswer);
                    }

                    // If this point is reached, it's not division, so check if it's correct for other operations
                    if ("Correct".equals(result)) {
                        mainDisplay.setText(result + ", hit 'New' to try another!");
                        secondAttemptAllowed = true; // The answer is correct, allow new problem
                    } else {
                        if (secondAttemptAllowed) {
                            mainDisplay.setText(firstNumber + lastOperation + secondNumber + "=");
                            secondAttemptAllowed = false;
                        } else {
                            mainDisplay.setText(result);
                            secondAttemptAllowed = true; // Allow a new problem after the wrong answer
                        }
                    }
                } catch (NumberFormatException ex) {
                    mainDisplay.setText("Error: Invalid Input");
                }
            }
        }
    }

}
