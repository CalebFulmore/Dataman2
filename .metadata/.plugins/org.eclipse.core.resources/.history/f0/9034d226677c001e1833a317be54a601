package dm3;

import java.awt.Color;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.concurrent.atomic.AtomicInteger;
import javax.swing.JTextField;
import javax.swing.SwingUtilities;

class ButtonClickListener implements ActionListener {
    private JTextField mainDisplay;
    private AnswerChecker answerChecker;
    private boolean secondAttemptAllowed;
    private String lastOperation;
    private int lastDividend;
    private int lastDivisor;
    private JTextField correctDisplay;
    private JTextField attemptDisplay;
    private AtomicInteger correctCount;
    private AtomicInteger attemptCount;
    private GuiView guiView;
    private MemoryBank memoryBank;
    private boolean isMemoryBankMode;

    public ButtonClickListener(JTextField mainDisplay, JTextField correctDisplay,
                               JTextField attemptDisplay, AtomicInteger correctCount,
                               AtomicInteger attemptCount, GuiView guiView,
                               MemoryBank memoryBank) {
        this.mainDisplay = mainDisplay;
        this.correctDisplay = correctDisplay;
        this.attemptDisplay = attemptDisplay;
        this.correctCount = correctCount;
        this.attemptCount = attemptCount;
        this.guiView = guiView;
        this.memoryBank = memoryBank;
        this.answerChecker = new AnswerChecker();
        this.secondAttemptAllowed = true;
    }

    @Override
    public void actionPerformed(ActionEvent e) {
        String command = e.getActionCommand();
        switch (command) {
            case "On":
            case "New":
                prepareNewProblem();
                break;
            case "Enter":
                evaluateAnswer();
                break;
            case "MemBank":
                saveEquationToMemory();
                break;
            case "Go":
                retrieveNextMemoryBankEquation();
                break;
            case "Off":
                resetCountsAndDisplays();
                break;
            default:
                appendToDisplay(command);
                break;
        }
    }

    private void prepareNewProblem() {
        mainDisplay.setText("=");
        secondAttemptAllowed = true;
        lastOperation = null;
        isMemoryBankMode = false; // Make sure we exit Memory Bank mode
    }

    private void saveEquationToMemory() {
        String equation = mainDisplay.getText();
        boolean success = memoryBank.saveToMemoryBank(equation);
        mainDisplay.setText(success ? "Saved to Memory Bank" : "Memory Bank Full");
    }

    private void retrieveNextMemoryBankEquation() {
        String equation = memoryBank.getNextEquation();
        if (equation != null) {
            mainDisplay.setText(equation + "=");
        } else {
            isMemoryBankMode = false; // Exit Memory Bank mode when no more equations
            mainDisplay.setText("Memory Bank Empty");
        }
    }

    private void resetCountsAndDisplays() {
        correctCount.set(0);
        attemptCount.set(0);
        correctDisplay.setText("0");
        attemptDisplay.setText("0");
        mainDisplay.setText("");
    }

    private void appendToDisplay(String command) {
        if ("=".equals(mainDisplay.getText())) {
            mainDisplay.setText("");
        }
        mainDisplay.setText(mainDisplay.getText() + command);
    }
    
    private String getCorrectAnswer(String operation, int dividend, int divisor) {
        switch (operation) {
            case "÷":
                int correctQuotient = dividend / divisor;
                int remainder = dividend % divisor;
                return correctQuotient + (remainder > 0 ? " R " + remainder : "");
            case "+":
                return String.valueOf(dividend + divisor);
            case "-":
                return String.valueOf(dividend - divisor);
            case "×":
                return String.valueOf(dividend * divisor);
            default:
                return "";
        }
    }


    private void evaluateAnswer() {
        String displayText = mainDisplay.getText();
        if (displayText.contains("=")) {
            // Extract the operation, numbers, and the answer
            String[] parts = displayText.split("[÷×\\-+]|=");
            if (parts.length == 3) {
                try {
                    int firstNumber = Integer.parseInt(parts[0].trim());
                    int secondNumber = Integer.parseInt(parts[1].trim());
                    int userAnswer = Integer.parseInt(parts[2].trim());
                    if (isMemoryBankMode) {
                        retrieveNextMemoryBankEquation(); // Move to the next equation
                        return; // Exit the method early since we don't want the normal evaluation to occur
                    }
                    String result = "";
                    boolean isCorrect = false; // Flag to indicate if the answer is correct
                    
                    if (displayText.contains("÷")) {
                        if (lastDivisor == 0) {
                            mainDisplay.setText("Can't Divide By Zero");
                        }
                        lastOperation = "÷";
                        lastDividend = firstNumber;
                        lastDivisor = secondNumber;
                        result = answerChecker.checkDivisionAnswer(firstNumber, secondNumber, userAnswer);
                        isCorrect = result.startsWith("Good job") || result.equals("Correct");
                    } else if (displayText.contains("+")) {
                        lastOperation = "+";
                        result = answerChecker.checkAdditionAnswer(firstNumber, secondNumber, userAnswer);
                        isCorrect = "Correct".equals(result);
                    } else if (displayText.contains("-")) {
                        lastOperation = "-";
                        result = answerChecker.checkSubtractionAnswer(firstNumber, secondNumber, userAnswer);
                        isCorrect = "Correct".equals(result);
                    } else if (displayText.contains("×")) {
                        lastOperation = "×";
                        result = answerChecker.checkMultiplicationAnswer(firstNumber, secondNumber, userAnswer);
                        isCorrect = "Correct".equals(result);
                    }
                    
                    // Check if the answer is correct and handle accordingly
                 // If the answer is correct
                    if (isCorrect) {
                        mainDisplay.setText(result + ", hit 'New' to try another!");
                        correctCount.incrementAndGet(); // Increment the correct count
                        secondAttemptAllowed = true; // The answer is correct, allow a new problem
                    } else {
                        // On second attempt, display the correct answer
                    	if (!secondAttemptAllowed) {
                            String nextEquation = memoryBank.getNextEquation();
                            if (nextEquation != null) {
                                mainDisplay.setText(nextEquation + "=");
                            } else {
                                mainDisplay.setText("Memory Bank Empty");
                            }
                            // After handling the above, reset secondAttemptAllowed for the new question
                            secondAttemptAllowed = true;
                        } else {
                            // If this is the first wrong attempt, allow for a second attempt
                            secondAttemptAllowed = false;
                        }
                        return; // This ensures we exit the method here when in Memory Bank mode
                    }if (!secondAttemptAllowed) {
                            String correctAnswer = getCorrectAnswer(lastOperation, lastDividend, lastDivisor);
                            mainDisplay.setText(correctAnswer); // Show the correct answer
                            // If in Memory Bank mode, try to retrieve the next question
                            if (isMemoryBankMode) {
                                retrieveNextMemoryBankEquation();
                            } else {
                                // If not in Memory Bank mode, prompt for a new problem
                                secondAttemptAllowed = true; // Reset to allow new problem
                            }
                        } else {
                            // First wrong attempt, prompt for second chance
                            mainDisplay.setText(firstNumber + lastOperation + secondNumber + "=");
                            secondAttemptAllowed = false;
                        }
                    }

                    // Flash logic for correct answers (should be outside the if-else block)
                    if (correctCount.get() == 10) {
                        SwingUtilities.invokeLater(() -> guiView.flashMultiColor(5000));
                    } else if (isCorrect) { // Only flash green if the answer was correct
                        SwingUtilities.invokeLater(() -> guiView.flashLight(Color.GREEN, 500, 2000));
                    }

                    // Increment the attempt count regardless of the answer being correct or incorrect
                    attemptCount.incrementAndGet();

                    // Update the display fields
                    correctDisplay.setText(String.valueOf(correctCount.get()));
                    attemptDisplay.setText(String.valueOf(attemptCount.get()));

                    
                } catch (NumberFormatException ex) {
                    mainDisplay.setText("Error: Invalid Input");
                }
                if (isMemoryBankMode) {
                    if (!secondAttemptAllowed) {
                        // Show the correct answer for the last question
                        String correctAnswer = getCorrectAnswer(lastOperation, lastDividend, lastDivisor);
                        mainDisplay.setText(lastDividend + " " + lastOperation + " " + lastDivisor + " = " + correctAnswer);
                        // After showing the correct answer, move to the next question
                        retrieveNextMemoryBankEquation();
                    } else {
                        // If this is the first wrong attempt, allow for a second attempt and don't change the display yet
                        secondAttemptAllowed = false;
                    }
                    return; // Exit the method early as we're in Memory Bank Mode
                }
            }
        }
    }

}
